{% extends "base.html" %} {% load static %} {% block content %}
<div class="container mt-4">
  <!-- Cabeçalho -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Novo Pedido</h2>
    <a href="{% url 'pedidos:index' %}" class="btn btn-secondary">Voltar</a>
  </div>

  <!-- Informação extra se vier de uma solicitação -->
  {% if solicitacao %}
  <div class="alert alert-info">
    <strong>Origem:</strong> Este pedido foi gerado a partir da
    <a href="{% url 'solicitacoes:detalhar_solicitacao' solicitacao.id %}"
      >Solicitação #{{ solicitacao.id }}</a
    >
  </div>
  {% endif %}

  <!-- Formulário -->
  <form method="post">
    {% csrf_token %}

    <!-- Fornecedor -->
    <div class="mb-3">
      <label for="fornecedor" class="form-label">Fornecedor</label>
      <select name="fornecedor" id="fornecedor" class="form-select" required>
        <option value="">Selecione um fornecedor</option>
        {% for fornecedor in fornecedores %}
        <option value="{{ fornecedor.id }}">
          {{ fornecedor.nome }} - {{ fornecedor.cnpj_cpf }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Local de entrega -->
    <div class="mb-3">
      <label for="local_entrega" class="form-label">Local de Entrega</label>
      <input
        type="text"
        name="local_entrega"
        id="local_entrega"
        class="form-control"
        placeholder="Ex: Almoxarifado Central"
      />
    </div>

    <!-- Prazo de entrega -->
    <div class="mb-3">
      <label for="prazo_entrega" class="form-label">Prazo de Entrega</label>
      <input
        type="text"
        name="prazo_entrega"
        id="prazo_entrega"
        class="form-control"
        placeholder="Ex: 15 dias"
      />
    </div>

    <!-- Centro de custo -->
    <div class="mb-3">
      <label for="centro_custo" class="form-label">Centro de Custo</label>
      <input
        type="text"
        name="centro_custo"
        id="centro_custo"
        class="form-control"
      />
    </div>

    <!-- Condição de pagamento -->
    <div class="mb-3">
      <label for="condicao_pagamento" class="form-label"
        >Condição de Pagamento</label
      >
      <input
        type="text"
        name="condicao_pagamento"
        id="condicao_pagamento"
        class="form-control"
        value="À vista"
      />
    </div>

    <!-- Observações -->
    <div class="mb-3">
      <label for="observacoes" class="form-label">Observações</label>
      <textarea
        name="observacoes"
        id="observacoes"
        class="form-control"
        rows="3"
      ></textarea>
    </div>

    <!-- Itens da Solicitação -->
    {% if itens %}
    <h4>Itens da Solicitação</h4>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Item</th>
          <th>Descrição</th>
          <th>Quantidade</th>
          <th>Preço Unitário</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody>
        {% for item in itens %}
        <tr>
          <td>{{ item.item }}</td>
          <td>{{ item.descricao }}</td>
          <td>
            <input
              type="number"
              class="form-control text-end"
              value="{{ item.quantidade }}"
              readonly
            />
            <input
              type="hidden"
              name="quantidade_{{ forloop.counter0 }}"
              value="{{ item.quantidade }}"
            />
          </td>
          <td>
            <input
              type="number"
              step="0.01"
              name="preco_unitario_{{ forloop.counter0 }}"
              class="form-control text-end preco-unitario"
              required
            />
          </td>
          <td class="subtotal text-end">0.00</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="4" class="text-end">Total:</th>
          <th id="total-geral" class="text-end">0.00</th>
        </tr>
      </tfoot>
    </table>
    {% endif %}

    <!-- Botões -->
    <button type="submit" name="action" value="save" class="btn btn-success">
      Salvar Pedido
    </button>
    <button type="submit" name="action" value="preview" class="btn btn-info">
      Pré-visualizar
    </button>
  </form>
</div>

<!-- Script para cálculo automático -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    function atualizarTotais() {
      let total = 0;
      document.querySelectorAll("tbody tr").forEach(function (row) {
        const qtd =
          parseFloat(row.querySelector("input[type=hidden]").value) || 0;
        const preco =
          parseFloat(row.querySelector(".preco-unitario").value) || 0;
        const subtotal = qtd * preco;
        row.querySelector(".subtotal").textContent = subtotal.toFixed(2);
        total += subtotal;
      });
      document.getElementById("total-geral").textContent = total.toFixed(2);
    }

    document.querySelectorAll(".preco-unitario").forEach(function (input) {
      input.addEventListener("input", atualizarTotais);
    });
  });
</script>
{% endblock %}
